################################################################################
# Stellar Ingest CI workflow
#
# - All commits, on all branches, get built and unit-tested.
# - Commits on branch devel (snapshots)  and master (releases), get packaged and
#   the binary artifacts (jars) published in the maven repository.
# - Commits from  master get  published only  if the version  string is  a valid
#   non-snapshot     and    they     have    an     annotated    version     tag
#   (stellar-ingest-VERSION), otherwise the step fails.
# - Commits  from devel  get published  only if  the version  string is  a valid
#   snapshot, otherwise  the step fails.  If  they have any tag  that suggests a
#   release version, the process fails as well.
# - Branches named 'develmoch/*'  and 'mastermoch/*' are treated  like devel and
#   master  respectively and  should  be  used exclusively  to  test/fix the  CI
#   workflow.
#
################################################################################

# Language settings ###########################################################

language: clojure
jdk: oraclejdk8

# Environment #################################################################

env:
  global:
    - INGEST_VERSION: $(lein project-version 2> /dev/null)
    - INGEST_TAG: $(git describe --tags 2> /dev/null)
    - secure: tvFri9dANU0EfA1l1aFwlo7Bd6LaHI3ljHS5sH93K14hoPPvFfMgrytyzgpEO+T+VDrm7oo529EZP93SRE5Re9yr+E2qOzGHB8nK+FHItu6kmmS07wMeUQUg3GaFBPH25sFERo4CzA+5pdqGm/iH8ZkB6OdSfoC3GQT5BxZvdt+l8CVJl6FIKkE4SZy+En80XBXB4GgCpJXcJZLtxJckNA/sHWVmLvOM+kUftFaJMGNoq6rSXGRtlqfS+s3XNmaLzfJ+yk6hxWQ+yDO8yTR5yN8bYc19gMtz9tJ1BJuNjnGhRE8dpYivYBqMp6lW4KvurPJJv7ZKo2l7fR9iimFaNbAtkiZ/G3lr2P6T3lB7Mxmm/iwVauHY1KKc3IXTnl124Cg5VlgFmOx5Iu99hssk+b6tfA/SiFYfHxyPgFf3LPGt3uYgCQTYR882U1aLvTcj9z7PxpwzbiP/Fg+0LNEnvLiMKpKUSsbRxa6DK3AziIDNsnCKPpjRLTlPZRbxHCJdYql6ynuHSNdXgOZbTopcT3wGoj+U8FWUJ0H3NRMhXUeDROOsHDsY7mGJ1e/beVV5NuC7M4g+Ew5x5njvPkscGOv/d4OQId/vxQAlvdbYGJ2nOMNvASUIp8bhWaO7qCIpL0f1iXpLIqLlNzBgCpMN7SUSHGlzf5vbe/yzb/mygCE=
    - secure: tl/fRxOzICFSASKdIftJ7XNAg2YhTSTsyQVqUY6k6iikjWbD57dOC0Dx5+AFxVpOCxw24Irrrj371D6LpduxDpblSH1fWUeHIMXLHrqkITSH9TwoacUIBR1KStObayuescl8i2OulTNFNCMIJUgOEuE0Mmv38a+MmsD5JzimuRL01dtMvVsgT+n7yE/KZ0Eth59Q8lOLy7DKbcryAb+xGPJIhH21NuvGS6oYz83EP914WSGmWs0TsgYiS0otRS6B2ykiBiRueWmUbowR5Ovq75AVZBtvkJki9iwBpadAdGxIr/2Zkh6hGNe//S+MYJeRV3c3lzF/JA2TWqN+n/dO8GhTGhgtYHRCIZyXecGrtSE5wmFcZi+io3cZGaUfM/j1tAE8/E1RR+55+88cx7HiYGgfUZpG5KtIROoJjDxP0epltiQA60hJSE0Ry+JD3DXVBLQOrXuZtaJSqdwQP+79PP532NFEJxwrCbN869KqFvLFtTpp0HGdPPIchossDlGn6g8lZnb09FORf21Q5w3WyjEkW1hBgPr8PyH9orHV8Vj0tkTK5hIumPk0P1MtNGYU1nqOm6lV/Ii+50dedNGjxmL7iPYFIqwDL2rLHn81aQ/D8zGMiOIxSK+b+CHLDxxhGjl+jqsZRk6VCL6afp+VZdQ11X2DCs70P/Atnd1EmVs=


# Pipeline stages ##############################################################

jobs:

  include:
  # Unit-testing is always performed.
  - stage: test
    script:
    - lein cloverage --coveralls
    - curl -F 'json_file=@target/coverage/coveralls.json' "https://coveralls.io/api/v1/jobs"

  # Publish development artifacts and docker images (snapshots) from branch devel
  - stage: publish
    if: branch = devel OR branch =~ ^develmock/
    script:
    - echo "Attempting to publish development version [$INGEST_VERSION] - tag [$INGEST_TAG]";
    - if [[ $INGEST_VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+-SNAPSHOT$ ]] &&
         [[ ! $INGEST_TAG =~ ^stellar-ingest-[0-9]+\.[0-9]+\.[0-9]$ ]] ; then
        echo "Publishing development version $INGEST_VERSION";
        lein deploy;
        lein deploy-uberjar;
        ./scripts/docker/build.sh;
      else
        echo "CONFLICT publishing development version [$INGEST_VERSION] - tag [$INGEST_TAG]";
        exit 1;
      fi
      
  # Publish stable artifacts and docker images (releases) from branch master
  - stage: release
    if: branch = master OR branch =~ ^mastermock/
    script:
    - if [[ $INGEST_VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]] &&
         [[ ! $INGEST_TAG = "stellar-ingest-$INGEST_VERSION" ]] ; then
        echo "Releasing version [$INGEST_VERSION]";        
        lein deploy;
        lein deploy-uberjar;
        ./scripts/docker/build.sh;
      else
        echo "CONFLICT releasing version [$INGEST_VERSION] - tag [$INGEST_TAG]";
        exit 1;
      fi

# # Notifications ################################################################

notifications:
  slack:
    secure: Y87bsz8T29L2SRL4Sh5e6JPPLd2AsSx42Cyo6GodSU7Yu+gduHKx+/iLzxr/N2sqTliuMMRDLpHP/4NuhMVhxyjC+Fld0aFVUwJdKnB+K+8Id8LdZqh0SznKYozbESDh+GMKwzHEGS2PSVqvlcFziuYmjAoXtufZS/k5xXuju4E3Ge3lgZqynOZ88UPVIPkAFaEBKrMG8izrzF8R6plrceH5DrQW3uF/JQURpQF0DdDAQzZuSbBgCRVyzP7vc7RkDiXJ3YbCcNQJs5WlUHdh1euKaK8eqwlqzJrlZV/qINR277GjUKV8tJO/iGW3AahS4M4NkWMdXyPPEpP1XzSmc1tIio8jp6syD/mLuucMu0F+QeR/SlvksxKqaUFZtlQBs94uFOx40Ew+fFbSmCm6UNeMpcwHtPR2t9SOSuh7fXN50X+5+fSXdrfe8Q5BgACDhl5C4li56zejLqN9//81LFnHFrDbGjaYZNAxrxj7shV2lTJiTuNbgK+WwfiZGz3copnDEAY0zPDP9aeK1Z4I5/74XzMVfIk76609MKboWO/e075mbKI0Gw7qv3gL9disokShOksUMCMEBLZMmpase7+7xSnj0jEHkjNhirMQ7UfsEGjE00qJlRye8srkmHSbphd7b5GogQz9EclOVtqn87KZagM9p1w/pQ9l2s+Cz8E=
  on_success: change
  on_failure: always
