################################################################################
# Stellar Ingest CI workflow
#
# - All commits, on all branches, get built and unit-tested.
# - Commits on branch devel (snapshots)  and master (releases), get packaged and
#   the binary artifacts (jars) published in the maven repository.
# - Commits from  master get  published only  if the version  string is  a valid
#   non-snapshot     and    they     have    an     annotated    version     tag
#   (stellar-ingest-VERSION), otherwise the step fails.
# - Commits  from devel  get published  only if  the version  string is  a valid
#   snapshot, otherwise  the step fails.  If  they have any tag  that suggests a
#   release version, the process fails as well.
# - Branches named 'develmoch/*'  and 'mastermoch/*' are treated  like devel and
#   master  respectively and  should  be  used exclusively  to  test/fix the  CI
#   workflow.
#
################################################################################

# Language settings ###########################################################

language: clojure
jdk: oraclejdk8

# Environment #################################################################

env:
  global:
    - INGEST_VERSION: $(lein project-version 2> /dev/null)
    - INGEST_TAG: $(git describe --tags 2> /dev/null)
    - secure: fwtQ4uYGmfz2ab41BGUnVxAgFNJgpgSgfhDz35zuqdxwEZ7eBaWVtzxHQwsjV4bVMYCZaXQrNSgoUkly54UOu9nL2JeI6ToEeX27htYoEZ+gg/miS7ALADZzEdv+10niAGllkboh699vGwIfjmFUysepqkgMIF//z3NPJZUB7P7IdNtIrvKlmjkd6FsZ32+xCV9jWfGTa/dicmIpldGyEKfvfoRXOh4cghBBhO0zgE+thYKzjedaumSxbKpEyaM7U+/eIemkWXGYHFIP7QE2VApFNLDamEgkkRXkc+AjdFhnTQZnfXMFFjXzqyvb+2YcgPl8t7zOGSEPzEp/jGVIE2CMz+zsp1w65C+P5zVFB176d9gIc8Rfph3nD/tK/3AY8UWMx5n9NdhEq/c3F+RAa/HLyVYTEF49K4zqtSTMCqxK6Xuqi5jHhWk+ZLRa2WNqDcvG6CBy8gOyFP+1elF2WdZAhGb/0cFMJkM5f5AQLjN8WhXoLJ5QIF6SGuYPZWBbed9bctK9JAvoCrofGAaw07PLrK3s9rAf4P2TgMEKbQX8VygG0rUEErbNuNI+P9HX1h4vK3tZFmMShZZqoCBc1WX1WRUsh0dIqw4skLe1c6QatKbAT+98tnkWOA/wSaaIdbT1iioFBewHfcztlJswzBZAuwssAZiYZNidDaypo88=
    - secure: luMYvT+T84QV21zjlwUS4kGLUNNtE4a5giQ8XMy74yYpCjWap+M5GXbQxCfMnhDUtlbqlAoxuTO4usYTGvET6UW2anpxUefnwVi2Z/chlwlJAWUPiXID7d1K9QnJFUWrm9nsooK8e3OggAr/d8SJO3m0ZYJ5B2tjrf/BiEQWqsre6kRb13KUsOED9NB+x9y8WIo//fpFlUuhe8nltmJUG23O/PCedlL8xQFfHiY0UjboUFM1sukpaWBtSliIpJy/D85oQ1XNB2iEgEDNod50mtNdp4IK/0gg1xb6HrFEl1T2Yg76qM209w93M0DxWOIUIH53OzebYczOq/f+unRCtkqnC7kYcoQf+4H3o/lP9M4Iy1MawebaqRsAtcwG+Bhbf2c7QKIPsOmzEvu76Ukz3ihS+TW5gy0zBExV0abtG4r1CjzyN4Dy7dJZFBU79ku/WDku//22ZrkJSZNGNt0twh99AwUnDkTE687Ak3wmaBoYLi/uuVwksipgdhQnQzRoIZr1E5q4P1ST8lR5PI0zXrjIelqto/4HMdhzA3wfiaMXwqJTHwbqNdBFZ+HAQTrIn6dWjj+AHw3htSzuJsc21E5ogK1vq1ToqQ4zo6qnsGUHMdapXt6zag6JsJDTtLeS+p+kkGLF9lkJ+BorerlrzQ9chWdgua0hqz22K+0JtR8=

# Pipeline stages ##############################################################

jobs:

  include:
  # Unit-testing is always performed.
  - stage: test
    script:
    - lein cloverage --coveralls
    - curl -F 'json_file=@target/coverage/coveralls.json' "https://coveralls.io/api/v1/jobs"

  # Publish development artifacts and docker images (snapshots) from branch devel
  - stage: publish
    if: branch = devel OR branch =~ ^develmock/
    script:
    - echo "Attempting to publish development version [$INGEST_VERSION] - tag [$INGEST_TAG]";
    - if [[ $INGEST_VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+-SNAPSHOT$ ]] &&
         [[ ! $INGEST_TAG =~ ^stellar-ingest-[0-9]+\.[0-9]+\.[0-9]$ ]] ; then
        echo "Publishing development version $INGEST_VERSION";
        lein deploy;
        lein deploy-uberjar;
        ./scripts/docker/build.sh;
      else
        echo "CONFLICT publishing development version [$INGEST_VERSION] - tag [$INGEST_TAG]";
        exit 1;
      fi
      
  # Publish stable artifacts and docker images (releases) from branch master
  - stage: release
    if: branch = master OR branch =~ ^mastermock/
    script:
    - if [[ $INGEST_VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]] &&
         [[ ! $INGEST_TAG = "stellar-ingest-$INGEST_VERSION" ]] ; then
        echo "Releasing version [$INGEST_VERSION]";        
        lein deploy;
        lein deploy-uberjar;
        ./scripts/docker/build.sh;
      else
        echo "CONFLICT releasing version [$INGEST_VERSION] - tag [$INGEST_TAG]";
        exit 1;
      fi

# # Notifications ################################################################

notifications:
  slack:
    secure: Y87bsz8T29L2SRL4Sh5e6JPPLd2AsSx42Cyo6GodSU7Yu+gduHKx+/iLzxr/N2sqTliuMMRDLpHP/4NuhMVhxyjC+Fld0aFVUwJdKnB+K+8Id8LdZqh0SznKYozbESDh+GMKwzHEGS2PSVqvlcFziuYmjAoXtufZS/k5xXuju4E3Ge3lgZqynOZ88UPVIPkAFaEBKrMG8izrzF8R6plrceH5DrQW3uF/JQURpQF0DdDAQzZuSbBgCRVyzP7vc7RkDiXJ3YbCcNQJs5WlUHdh1euKaK8eqwlqzJrlZV/qINR277GjUKV8tJO/iGW3AahS4M4NkWMdXyPPEpP1XzSmc1tIio8jp6syD/mLuucMu0F+QeR/SlvksxKqaUFZtlQBs94uFOx40Ew+fFbSmCm6UNeMpcwHtPR2t9SOSuh7fXN50X+5+fSXdrfe8Q5BgACDhl5C4li56zejLqN9//81LFnHFrDbGjaYZNAxrxj7shV2lTJiTuNbgK+WwfiZGz3copnDEAY0zPDP9aeK1Z4I5/74XzMVfIk76609MKboWO/e075mbKI0Gw7qv3gL9disokShOksUMCMEBLZMmpase7+7xSnj0jEHkjNhirMQ7UfsEGjE00qJlRye8srkmHSbphd7b5GogQz9EclOVtqn87KZagM9p1w/pQ9l2s+Cz8E=
  on_success: change
  on_failure: always
